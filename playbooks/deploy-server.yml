# File: deploy-server.yml
#
# Purpose
# Configures a baseline Windows Server 2022 file server.
# Installs the File Server role, creates share directories,
# publishes an SMB share, and applies NTFS + share permissions.
#
# Scope
# Standalone system
# Local permissions only (no domain required)
#
# Environment
# Windows Server 2022
# WinRM enabled
# Local Administrator credentials

- name: Install File Server role
  ansible.windows.win_feature:
    name: FS-FileServer
    state: present

- name: Create root share directory
  ansible.windows.win_file:
    path: "{{ file_share_root }}"
    state: directory

- name: Create share directories
  ansible.windows.win_file:
    path: "{{ file_share_root }}\\{{ item.name }}"
    state: directory
  loop: "{{ shares }}"

- name: Set NTFS permissions (Admins)
  ansible.windows.win_acl:
    path: "{{ file_share_root }}\\{{ item.0.name }}"
    user: "{{ item.1 }}"
    rights: FullControl
    type: allow
    inheritance: ContainerInherit,ObjectInherit
    state: present
  loop: "{{ shares | subelements('admins') }}"

- name: Set NTFS permissions (Users)
  ansible.windows.win_acl:
    path: "{{ file_share_root }}\\{{ item.0.name }}"
    user: "{{ item.1 }}"
    rights: Modify
    type: allow
    inheritance: ContainerInherit,ObjectInherit
    state: present
  loop: "{{ shares | subelements('users') }}"

- name: Create SMB shares
  ansible.windows.win_share:
    name: "{{ item.name }}"
    path: "{{ file_share_root }}\\{{ item.name }}"
    description: "{{ item.description }}"
    full: "{{ item.admins[0] }}"
    change: "{{ item.users[0] }}"
    state: present
  loop: "{{ shares }}"
